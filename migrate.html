<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Migration Tool</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #34495e; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .container { background-color: white; padding: 2rem 3rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; max-width: 600px; width: 90%; }
        button { background-color: #007bff; color: white; padding: 12px 25px; font-size: 1rem; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        button:hover { background-color: #0056b3; transform: scale(1.05); }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #log-output { background-color: #2d3748; color: #f7fafc; padding: 1rem; border-radius: 8px; text-align: left; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; margin-top: 2rem; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Service Data Migration</h1>
        <p>This tool will find all products with `listing_type: 'service'` and copy them to the new `services` collection.</p>
        <p><strong>Important:</strong> This will not delete the old items. Run this script only once.</p>
        <button id="start-migration-btn">Start Migration</button>
        <div id="log-output">Migration log will appear here...</div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const startBtn = document.getElementById('start-migration-btn');
        const logOutput = document.getElementById('log-output');

        function log(message, isError = false) {
            console.log(message);
            const p = document.createElement('p');
            p.textContent = message;
            if (isError) p.style.color = '#e53e3e';
            logOutput.appendChild(p);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            startBtn.textContent = 'Migration in Progress...';
            logOutput.innerHTML = '';
            log('Starting migration...');

            try {
                const productsRef = collection(db, "products");
                const servicesRef = collection(db, "services");

                const q = query(productsRef, where("listing_type", "==", "service"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    log('No services found in the "products" collection. Nothing to migrate.');
                    startBtn.textContent = 'Migration Finished';
                    return;
                }

                log(`Found ${querySnapshot.size} services to migrate.`);
                let successCount = 0;

                for (const doc of querySnapshot.docs) {
                    const oldData = doc.data();
                    log(`Migrating: ${oldData.name || 'Untitled Product'}...`);
                    
                    // --- THIS IS THE FINAL FIX ---
                    // It checks for missing data and provides safe default values
                    // instead of crashing with an "undefined" error.
                    if (!oldData.sellerId || !oldData.sellerName) {
                        log(`  -> SKIPPING: Missing sellerId or sellerName.`, true);
                        continue; // Skip this document and move to the next one
                    }

                    const newServiceData = {
                        title: oldData.name || "Untitled Service",
                        description: oldData.description || "No description provided.",
                        price: oldData.price || 0,
                        whatsapp: oldData.whatsapp || "",
                        imageUrl: oldData.imageUrls && oldData.imageUrls.length > 0 ? oldData.imageUrls[0] : "",
                        providerId: oldData.sellerId,
                        providerName: oldData.sellerName,
                        createdAt: oldData.createdAt || serverTimestamp(),
                        isFeatured: false
                    };

                    await addDoc(servicesRef, newServiceData);
                    successCount++;
                    log(`  -> Successfully copied "${newServiceData.title}" to the services collection.`);
                }

                log(`\nMigration Complete! Successfully migrated ${successCount} of ${querySnapshot.size} services.`, false);
                startBtn.textContent = 'Migration Finished';

            } catch (error) {
                log(`\nFATAL ERROR: Migration failed.`, true);
                log(error.message, true);
                console.error(error);
                startBtn.textContent = 'Migration Failed';
            }
        });
    </script>
</body>
</html>